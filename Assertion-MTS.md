# Real Me (MTS) Assertion Service - Azure AD B2C integration

RealMe uses a "Messaging Test Site" (MTS) environment as the first stepping zone to perform a prototype technical integration.

This projects explains how to integrate the RealMe MTS environment as a SAML identity provider into Azure AD B2C. It uses Azure AD B2C custom policies.

In this tutorial:

- RealMe is treated as an external identity provider (IdP).
- The only configured IdP is RealMe and we don't ask user to provide any further information so from a user perspective there is no interaction with Azure AD B2C. To configure more complex user journey, please refer to the [Useful links section](#useful-links)

## What is the RealMe MTS Environment

Integrating into an IdP such as RealMe over the SAML protocol requires the exchange of two key items

- SAML metadata
- SAML messaging certificates for signing and encrypting the SAML traffic

These items need to be exchanged between parties and configured into the SAML providers on both sides. So in RealMe's case DIA need to configure the RealMe Azure AD B2C and the integrating party (RP) also needs to configure their SAML provider (e.g. another Azure AD B2C tenant). This sets up a "circle of trust" in SAML speak between the two SAML providers.

However for integrators getting up to speed and trying out a RealMe integration for the first time DIA provides a Messaging Test Site (MTS) with a sample set of SAML messaging keys of a 'test integrator' configured. All the integrator needs to do is:

- obtain these keys and configure their Azure AD B2C tenant with them
- generate their SAML metadata accordingly and upload to a feature on the RealMe MTS to allow the SAML messaging to occur successfully.

That is the overall picture. This guide walks through the detailed technical steps involved to colour in that picture.

## Creating an Azure AD B2C Tenant

Follow [this tutorial](https://docs.microsoft.com/en-us/azure/active-directory-b2c/tutorial-create-tenant) to:

- Create a new Azure AD B2C tenant
- Link your Azure AD B2C tenant to a subscription

## Creating Signing and Encryption Keys

Follow [this tutorial](https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-get-started-custom#add-signing-and-encryption-keys) to:

1. Sign in to the [Azure portal](https://portal.azure.com/) as the global administrator of your Azure AD B2C tenant.
2. Make sure you're using the directory that contains your Azure AD B2C tenant. Click the **Directory and subscription filter** in the top menu and choose the directory that contains your tenant.
3. Choose **All services** in the top-left corner of the Azure portal, search for and select **Azure AD B2C**.
4. On the Overview page, select **Identity Experience Framework**.

### Create a signing key used to sign the id_token return by Azure AD B2C

1. Select **Policy Keys** and then select **Add**.
2. For **Options**, choose `Generate`.
3. In **Name**, enter `TokenSigningKeyContainer`. The prefix `B2C_1A_` will be added automatically.
4. For **Key type**, select `RSA`.
5. For **Key usage**, select `Signature`.
6. Click **Create**.

### Create an encryption key used to encrypt the refresh_token return by Azure AD B2C

1. Select **Policy Keys** and then select **Add**.
2. For **Options**, choose `Generate`.
3. In **Name**, enter `TokenEncryptionKeyContainer`. The prefix `B2C_1A_` will be added automatically.
4. For **Key type**, select `RSA`.
5. For **Key usage**, select `Encryption`.
6. Click **Create**.

## Upload the MTS certificate used between Azure AD B2C and RealMe to exchange data

For the MTS environment integrators can obtain a bundle that contains keys and metadata to integrate.  

In the real word environment a private key and public key pair would be generated by the integrating Azure AD B2C tenant and the public key sent to RealMe to configure the 'circle of trust' settings on the RealMe side.
However, to make testing the integration easier in the MTS environment RealMe provides a pre-integrated set of keys (public-private key pair) that integrators can accept and reuse to get up and running quickly.
These keys are already pre-trusted in the RealMe MTS environment. It also assumes that of course no sensitive information is exchanged between the MTS RealMe and your integrating site.

1. Download the `Messaging Test Site bundle zip` from the [RealMe Developer Website](https://developers.realme.govt.nz/try-it-out-now/) and unzip it.
2. Rename the file `mts_saml_sp.p12` to `mts_saml_sp.pfx`.
3. Select **Policy Keys** and then select **Add**.
4. For **Options**, choose `Upload`.
5. In **Name**, enter `RealMeMTSSamlMessageSigning`. The prefix B2C_1A_ might be added automatically.
6. In **File upload**, select the `mts_saml_sp.pfx` file.
7. In **Password**, enter the password of the certificate. You can find this information in the root `readme.txt` file in the `Messaging Test Site bundle zip` zipped file.
8. Click **Create**.

## Customising the Custom Policies Files

The policies files used in this tutorial have been modified from the [SocialAndLocalAccounts](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/tree/master/SocialAndLocalAccounts) starter pack.

To know more about policies files, you can read the associated documentation: [Policy files](https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-overview-custom#policy-files)

1. Download these files:

- [RealMeAssertTrustFrameworkBase.xml](./RealMe-Assertion-MTS/RealMeAssertTrustFrameworkBase.xml)
- [RealMeAssertTrustFrameworkExtensions.xml](./RealMe-Assertion-MTS/RealMeAssertTrustFrameworkExtensions.xml)
- [RealMeAssertSignUpSignIn.xml](./RealMe-Assertion-MTS/RealMeAssertSignUpSignIn.xml)

2. In these files, replace these parameters and save the files.:

- `yourtenant` with the name of your B2C tenant (without the `.onmicrosoft.com`)
- `yourEntityID` with a valid RealMe Issuer (see [RealMe request parameters](https://developers.realme.govt.nz/how-realme-works/realme-request-parameters)) in this format `https://www.agencyname.govt.nz/context/application-name`
  - Note this needs to occur in 2 places:
  - In the Metadata section: 
    - `<Item Key="IssuerUri">yourEntityID</Item>`
  - In the OutputCLaims section
    - `<OutputClaim ClaimTypeReferenceId="issuerUserId" PartnerClaimType="yourEntityID" />`

3. Update the RealMe SAML Metadata

- From the `Messaging Test Site bundle zip` (see previous step), open the `MTSIdPAssertionSAMLMetadata.xml` file.
- Copy the content of the file (do not copy the `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>` line).
- Open the `RealMeAssertTrustFrameworkExtensions.xml` and paste into the line `Add RealMe Metadata Here`:

    ```xml
    <Item Key="PartnerEntity"><![CDATA[
    Add RealMe Metadata Here
    ]]>
    ```

- Save your changes.

5. Upload the Policies:

- On the Custom Policies page of Identity Experience Framework, select **Upload Policy**.
- In this order, upload
  - `RealMeAssertTrustFrameworkBase.xml`
  - `RealMeAssertTrustFrameworkExtensions.xml`
  - `RealMeAssertSignUpSignIn.xml`.

## Upload the B2C Metadata File to RealMe

1. Download the B2C metadata file (replace `yourtenant` with the name of your B2C tenant):
  `https://yourtenant.b2clogin.com/yourtenant.onmicrosoft.com/B2C_1A_RealMeAssertSignUpSignIn/samlp/metadata?idptp=RealMeAssertion-SAML2`

- If you want to use the `login.microsoftonline.com` domain, download the metadata file from this url (replace `yourtenant` with the name of your B2C tenant):
  `https://login.microsoftonline.com/yourtenant.onmicrosoft.com/B2C_1A_RealMeAssertSignUpSignIn/samlp/metadata?idptp=RealMeAssertion-SAML2`

2. Open the file and

- Remove the `<Signature>...</Signature>` tag.

3. Browse this url: <https://mtscloud.realme.govt.nz/Assertion/home>

- Read the 'Core MTS Integration Steps'
  - Follow the link to configure the entityID and upload the SP metadata: <https://mtscloud.realme.govt.nz/Assertion/Metadata/Validate>
  - Select the metadata file you want to upload then click **Upload File**.
  - On the next page, assuming no errors where detected, click **Import** then **Continue**.
- Update your configuration: <https://mts.realme.govt.nz/realme-mts/metadata/updateconfiguration.xhtml>

  - Click [View Update Configuration](https://mtscloud.realme.govt.nz/Assertion/Metadata/SelectConfig)
- Enter `yourEntityID` in the **entity ID** field.
  - Select Assertion Flow: AssertOnly
  - ResponseFormat : JSON
  - Return Identity : yes
  - Return Address: yes
- Click **Update**.

## Testing the Policy

To test the policy, create an application registration in the Azure AD B2C tenant.
The configuration will direct the response to be send to <https://jwt.ms/>.  
This is a Microsoft developer tool site that allows the RealMe response as processed from the custom policies to be viewed and understood.  The <https://jwt.ms/> is a provided tool that does need some some extra configuration to work on enabling the implicit flow features. These are described in the steps below.

1. In the Azure AD B2C Tenant, Click on **Identity Experience Framework**.
1. Click on **App registrations**.
1. On the application page, click on **+ New registration**
1. On the application creation page
    - Enter `jwt.ms` in the **Name** field.
    - Redirect URI
      - Select Web
      - Enter `https://jwt.ms/` for the URI
    - Select **Register**
    - Return to the  **App registrations** page and click on the application that was just created.
    - On the left hand side click on **Authentication**
    - Under the section on Implicit grant and hybrid flows check the flowing checkboxes
      - Access tokens (used for implicit flows)
      - ID tokens (used for implicit and hybrid flows)
    - Please note: These OAuth2/OIDC implicit flows features are not normally used in an application integration using the authorization code flow. They are only enabled here to make the <https://jwt.ms/> tool able to inspect the returned tokens from the B2C custom policies that we are testing for.

1. On the  **Identity Experience Framework**, select the `B2C_1A_REALMEASSERTSIGNUPSIGNIN` policy:
1. The previously created application should be preselected with the select `jwt.ms` in the **Select application** dropdown.
1. Click on the **Run now** button, you will be redirected to RealMe
1. On the RealMe website, fill the IVs attributes then click on `Initiate SAML Response`, it will redirect you to the <https://jwt.ms/> website.

### Understanding the response

In the top level policy file `RealMeAssertSignUpSignIn.xml` it contains

```xml
  <RelyingParty>
    <DefaultUserJourney ReferenceId="SignUpSignInRealMeAssertion" />
    <TechnicalProfile Id="PolicyProfile">
      <DisplayName>PolicyProfile</DisplayName>
      <Protocol Name="OpenIdConnect" />
      <OutputClaims>
        <OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="sub" />
        <OutputClaim ClaimTypeReferenceId="issuerUserId" />
        <OutputClaim ClaimTypeReferenceId="identityProvider" />
        <OutputClaim ClaimTypeReferenceId="fit" />
        <OutputClaim ClaimTypeReferenceId="safeB64Identity" />
        <OutputClaim ClaimTypeReferenceId="safeB64Address" />
      </OutputClaims>
      <SubjectNamingInfo ClaimType="sub" />
    </TechnicalProfile>
  </RelyingParty>
```

The `Protocol` of `OpenIdConnect` tells the custom policy to take the SAML response from RealMe and translate it into an OIDC response. Hence the  <https://jwt.ms/> tool shows the returned token as a OIDC JWT not a SAML XML response.

A sample response will look like:

```json
{
  "alg": "RS256",
  "kid": "dFUoLGAfrYu0EFZ67ZoSplZFzlFYBOpUkBs7zXu4_A0",
  "typ": "JWT"
}.{
  "ver": "1.0",
  "iss": "https://identityfoundry.b2clogin.com/75942a80-f984-48a1-88ae-1454d6ad0c9f/v2.0/",
  "sub": "6081ec94-3c07-444a-a198-db0ae4c1121f",
  "aud": "3d41a96f-26d7-4d29-866c-781172f2d2d8",
  "exp": 1709256159,
  "acr": "b2c_1a_realmeassertsignupsignin",
  "nonce": "defaultNonce",
  "iat": 1709252559,
  "auth_time": 1709252559,
  "issuerUserId": "ca3b2ff4-b690-402d-906f-5f7e26064e3b",
  "fit": "AZUAB8488958A4B421D9FA4AE4955B82B9F",
  "safeB64Identity": "eyJuYW1lIjp7ImZpcnN0TmFtZSI6IlJpY2hhcmQiLCJtaWRkbGVOYW1lIjoiSiIsImxhc3ROYW1lIjoiQmVyZ3F1aXN0IiwibmFtZURpc3B1dGVkIjpmYWxzZX0sInBsYWNlT2ZCaXJ0aCI6eyJsb2NhbGl0eSI6IlRha2FwdW5hIiwiY291bnRyeSI6Ik5ldyBaZWFsYW5kIiwicGxhY2VPZkJpcnRoRGlzcHV0ZWQiOmZhbHNlfSwiZ2VuZGVyIjp7ImdlbmRlclZhbHVlIjoiTSIsImdlbmRlckRpc3B1dGVkIjpmYWxzZX0sImRhdGVPZkJpcnRoIjp7ImRhdGVPZkJpcnRoVmFsdWUiOiIxOTE5LTAyLTA3IiwiZGF0ZU9mQmlydGhEaXNwdXRlZCI6ZmFsc2V9fQ==",
  "safeB64Address": "eyJzdHJlZXQiOiIxNyBMeWRpYSBBdmUiLCJzdWJ1cmIiOiJOb3J0aGNvYXQiLCJjaXR5IjoiQXVja2xhbmQiLCJjb3VudHJ5IjoiTlpMIn0=",
  "idp": "realme.govt.nz",
  "nbf": 1709252559
}.[Signature]
```

Note:

- The `sub` claim contains the B2C `objectid`. You will be able to see this user created in the list of users registered in B2C.
- The `idp` claim contains the B2C `realme.govt.nz`.
- The `issuerUserId` claim the transient NameID returned in the SAML response. This is may have no use.
- The `fit` claim contains the RealMe `FIT`.
- The `acr` is the name of the custom policy
- The `iss` is the URI of the Azure AD B2C tenant name and tenantID.
- Typically the `aud` is the client_id of the registered application. It has been noted that with an RealMe MTS integration this value appears to change when returned from B2C, for reasons not clear.
- The `safeB64Identity` is the safeBase64 encoded identity payload - the RealMe Verified Identity.
- The `safeB64Address` is the safeBase64 encoded address payload - the RealMe Verified Address.
- The `issuerUserId` and `fit` claims will be returned correctly once integrated in the RealMe ITE environment.

## Decoding the Verified Identity and Address

The verified identity and address is returned as SAML attributes that are safe base64 encoded JSON payloads. These payloads can be passed back as-is as claims strings for the application to decode. Alternatively, the parsing of the base64 encoded JSON strings can also occur in the Azure AD B2C custom policy with the addition of the following extension logic.

To decode the identity and address as part of the B2C journey, you can refer to this link that describes how to add an REST API connection into the custom policy flow.

- [Walkthrough: Integrate REST API claims exchanges in your Azure AD B2C user journey as validation on user input](https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-rest-api-validation-custom)

Then you can use this code snippet to decode the safe base64 identity and address (in C#):

```C#
using System;
using System.Text;
...
private static string ConvertFromSafeBase64String(string safeb64)
{
  // See https://tools.ietf.org/html/rfc3548#section-4
  var base64 = safeb64.Replace("-", "+").Replace("_", "/");
  return Encoding.UTF8.GetString(Convert.FromBase64String(base64));
}
```

Refer to this link for further more complete documentation on [how to decode RealMe identity claims](./Decoding-RealMe-Claims.md).

## Useful Links

Azure Active Directory B2C:

- [Azure Active Directory B2C Overview](https://azure.microsoft.com/en-us/services/active-directory-b2c/)
- [Custom policies in Azure Active Directory B2C](https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-overview-custom)
- [Define a SAML technical profile in an Azure Active Directory B2C custom policy](https://docs.microsoft.com/en-us/azure/active-directory-b2c/saml-technical-profile)
- [Azure Active Directory B2C: Collecting Logs](https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-troubleshoot-custom)

Real Me:

- [RealMe for developers](https://developers.realme.govt.nz/)
- [RealMe assertion service MTS](https://mts.realme.govt.nz/realme-mts/home/information.xhtml)
